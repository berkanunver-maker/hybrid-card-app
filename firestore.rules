rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidString(text, minLen, maxLen) {
      return text is string &&
             text.size() >= minLen &&
             text.size() <= maxLen;
    }

    // Users Collection
    match /users/{userId} {
      // Users can read and write only their own profile
      allow read, write: if isOwner(userId);

      // Validate user data on create/update
      allow create, update: if isOwner(userId) &&
        request.resource.data.keys().hasAll(['email', 'displayName']) &&
        isValidEmail(request.resource.data.email) &&
        isValidString(request.resource.data.displayName, 1, 100);
    }

    // Categories Collection
    match /categories/{categoryId} {
      // Users can only access their own categories
      allow read, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // Validate category data on create
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['name', 'userId', 'createdAt']) &&
        isValidString(request.resource.data.name, 1, 100);

      // Validate category data on update
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid &&
        isValidString(request.resource.data.name, 1, 100);
    }

    // Cards Collection
    match /cards/{cardId} {
      // Users can only access their own cards
      allow read, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // Validate card data on create
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['userId', 'createdAt']) &&
        // Optional fields validation
        (!request.resource.data.keys().hasAny(['name']) || isValidString(request.resource.data.name, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['email']) || isValidEmail(request.resource.data.email)) &&
        (!request.resource.data.keys().hasAny(['phone']) || isValidString(request.resource.data.phone, 0, 50)) &&
        (!request.resource.data.keys().hasAny(['company']) || isValidString(request.resource.data.company, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['title']) || isValidString(request.resource.data.title, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['address']) || isValidString(request.resource.data.address, 0, 500));

      // Validate card data on update
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid &&
        // Optional fields validation
        (!request.resource.data.keys().hasAny(['name']) || isValidString(request.resource.data.name, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['email']) || isValidEmail(request.resource.data.email)) &&
        (!request.resource.data.keys().hasAny(['phone']) || isValidString(request.resource.data.phone, 0, 50)) &&
        (!request.resource.data.keys().hasAny(['company']) || isValidString(request.resource.data.company, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['title']) || isValidString(request.resource.data.title, 0, 200)) &&
        (!request.resource.data.keys().hasAny(['address']) || isValidString(request.resource.data.address, 0, 500));
    }

    // Fairs Collection
    match /fairs/{fairId} {
      // Users can only access their own fairs
      allow read, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;

      // Validate fair data on create
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['name', 'userId', 'createdAt']) &&
        isValidString(request.resource.data.name, 1, 200);

      // Validate fair data on update
      allow update: if isSignedIn() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid &&
        isValidString(request.resource.data.name, 1, 200);
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
